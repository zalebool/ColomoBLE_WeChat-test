/**************************************************************************************************
  Filename:       bsp_ruby_tmp.c
  Revised:        $Date: 2015/9/10 $
  Revision:       $Revision: 1 $

  Description:    This file contains the interface to the bsp ruby temperature measurement.

  Copyright 2015 - 2016 QijiTek. All rights reserved.
**************************************************************************************************/

/***************************************************************************************************
 *                                             INCLUDES
 ***************************************************************************************************/
#include "hal_mcu.h"
#include "hal_defs.h"
#include "hal_types.h"
#include "hal_drivers.h"
#include "osal.h"
#include "hal_board.h"
#include "hal_i2c.h"
#include "bsp_ruby_res.h"
#include "hal_adc.h"

/***************************************************************************************************
 *                                             CONSTANTS
 ***************************************************************************************************/

/***************************************************************************************************
 *                                              MACROS
 ***************************************************************************************************/

/***************************************************************************************************
 *                                              TYPEDEFS
 ***************************************************************************************************/


/***************************************************************************************************
 *                                           GLOBAL VARIABLES
 ***************************************************************************************************/

/***************************************************************************************************
 *                                            LOCAL FUNCTION
 ***************************************************************************************************/

/***************************************************************************************************
 *                                            FUNCTIONS - API
 ***************************************************************************************************/
/***************************************************************************************************
 * @fn      BspRubyTmpInit
 *
 * @brief   Initialize Comparator
 *
 * @param   None
 *          
 *          
 *                    
 *
 * @return  None
 ***************************************************************************************************/
void BspRubyResInit()
{
  APCFG |= BV(2);
  P0DIR |= BV(1);
 // BSP_TMP_SNS_APCFG |= BSP_TMP_SNS_BV;
}

/***************************************************************************************************
 * @fn      BspRubyTmpMeas_offchip
 *
 * @brief   Get temperature value from offchip sensor
 *
 * @param   None
 *          
 *          
 *                    
 *
 * @return  None
 ***************************************************************************************************/
uint16 BspRubyResMeas()
{
  uint8 i;
  uint32 tmp=0;
  uint32 voltage;
  P0_1=1;
  HalAdcSetReference(HAL_ADC_REF_AVDD);
  
  for(i=0;i<4;i++){
    voltage = HalAdcRead(HAL_ADC_CHN_AIN2,HAL_ADC_RESOLUTION_14);
    // tmp = tmp+(1000*voltage/(8192-voltage));
    tmp += voltage;
  }
  tmp = tmp >> 2;
  // tmp = voltage/4;
//  for(i=0;i<140;i++)
//  {
//    if((tmp<=tmp_table[i])&&(tmp>tmp_table[i+1]))
//    {
//      result = i/2;
//      break;
//    }
//  }
  P0_1=0;
  return (uint16)tmp;
}
 
/***************************************************************************************************
***************************************************************************************************/