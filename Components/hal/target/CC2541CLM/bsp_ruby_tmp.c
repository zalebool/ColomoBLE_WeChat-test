/**************************************************************************************************
  Filename:       bsp_ruby_tmp.c
  Revised:        $Date: 2015/9/10 $
  Revision:       $Revision: 1 $

  Description:    This file contains the interface to the bsp ruby temperature measurement.

  Copyright 2015 - 2016 QijiTek. All rights reserved.
**************************************************************************************************/

/***************************************************************************************************
 *                                             INCLUDES
 ***************************************************************************************************/
#include "hal_mcu.h"
#include "hal_defs.h"
#include "hal_types.h"
#include "hal_drivers.h"
#include "osal.h"
#include "hal_board.h"
#include "hal_i2c.h"
#include "bsp_ruby_tmp.h"
#include "hal_adc.h"

/***************************************************************************************************
 *                                             CONSTANTS
 ***************************************************************************************************/
/*
const uint16 tmp_table[141] = 
{ 10538,  10219,   9911,   9613,   9325,   9047,   8778,   8519,   8267,   8025, 
  7790,   7563,   7343,   7131,   6925,   6727,   6534,   6348,   6168,   5993, 
  5825,   5661,   5503,   5350,   5201,   5057,   4918,   4783,   4652,   4525, 
  4403,   4284,   4168,   4056,   3948,   3843,   3740,   3642,   3546,   3452, 
  3362,   3274,   3189,   3107,   3027,   2949,   2873,   2800,   2729,   2660, 
  2592,   2527,   2464,   2402,   2343,   2284,   2228,   2173,   2120,   2068, 
  2017,   1968,   1921,   1874,   1829,   1786,   1743,   1701,   1661,   1622, 
  1584,   1547,   1510,   1475,   1441,   1408,   1375,   1343,   1313,   1283, 
  1254,   1225,   1197,   1170,   1144,   1119,   1094,   1069,   1046,   1023, 
  1000,    978,    957,    936,    916,    896,    876,    858,    839,    821, 
   804,    787,    770,    754,    738,    722,    707,    693,    678,    664, 
   651,    637,    624,    611,    599,    587,    575,    563,    552,    541, 
   530,    520,    509,    499,    489,    480,    470,    461,    452,    443, 
   435,    426,    418,    410,    402,    395,    387,    380,    373,    366, 
   359};//-20~50, step=0.5
*/
/***************************************************************************************************
 *                                              MACROS
 ***************************************************************************************************/

/***************************************************************************************************
 *                                              TYPEDEFS
 ***************************************************************************************************/


/***************************************************************************************************
 *                                           GLOBAL VARIABLES
 ***************************************************************************************************/

/***************************************************************************************************
 *                                            LOCAL FUNCTION
 ***************************************************************************************************/

/***************************************************************************************************
 *                                            FUNCTIONS - API
 ***************************************************************************************************/
/***************************************************************************************************
 * @fn      BspRubyTmpInit
 *
 * @brief   Initialize Comparator
 *
 * @param   None
 *          
 *          
 *                    
 *
 * @return  None
 ***************************************************************************************************/
void BspRubyTmpInit()
{
  
  BSP_TMP_SNS_APCFG |= BSP_TMP_SNS_BV;
}

/***************************************************************************************************
 * @fn      BspRubyTmpMeas_offchip
 *
 * @brief   Get temperature value from offchip sensor
 *
 * @param   None
 *          
 *          
 *                    
 *
 * @return  None
 ***************************************************************************************************/
uint16 BspRubyTmpMeas()
{
  uint8 i;
  uint32 tmp=0;
  uint32 voltage;
  
  BSP_TMP_CHG_SBIT = 1;
  HalAdcSetReference(HAL_ADC_REF_AVDD);
  
  for(i=0;i<4;i++){
    voltage = HalAdcRead(HAL_ADC_CHN_AIN6,HAL_ADC_RESOLUTION_14);
    // tmp = tmp+(1000*voltage/(8192-voltage));
    tmp += voltage;
  }
  BSP_TMP_CHG_SBIT = 0;
  
  tmp = tmp/4;
  // tmp = voltage/4;
//  for(i=0;i<140;i++)
//  {
//    if((tmp<=tmp_table[i])&&(tmp>tmp_table[i+1]))
//    {
//      result = i/2;
//      break;
//    }
//  }
  
  return (uint16)tmp;
}
 
/***************************************************************************************************
***************************************************************************************************/




